<!DOCTYPE html>
<html>
<head>
    <title>Game Hub</title>
    <style>
        body { background:#000; color:#fff; font-family:sans-serif; padding:20px; text-align:center; }
        #game-menu { margin-bottom:20px; }
        .game-btn { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
        #emulator-container { display:none; }
        #canvas { border:2px solid #0f0; max-width:100%; margin-top:20px; }
        #back-btn { margin-top:10px; }
        #status { margin-top:12px; color:#8f8; }
    </style>
</head>
<body>
    <h1>ðŸŽ® Game Hub</h1>
    
    <!-- Game Selection Menu -->
    <div id="game-menu">
        <h2>Choose a Game:</h2>
        <button class="game-btn" onclick="loadGame('gba', 'games/emerald.gba')">PokÃ©mon Emerald</button>
        <button class="game-btn" onclick="loadGame('snes', 'games/zelda.smc')">Zelda: LTTP</button>
    </div>
    
    <!-- Emulator Container -->
    <div id="emulator-container">
        <div id="status"></div>
        <canvas id="canvas"></canvas><br>
        <button id="back-btn" onclick="location.reload()">Back to Games</button>
    </div>
    
    <script>
        // Display status messages to the user
        function showStatus(msg, isError) {
            const s = document.getElementById('status');
            if (!s) return;
            s.textContent = msg;
            s.style.color = isError ? '#f88' : '#8f8';
        }

        // Ensure the emulator loader is added only once and provide a promise interface
        function ensureEmulatorLoader(timeoutMs = 15000) {
            return new Promise((resolve, reject) => {
                // If loader already loaded, resolve immediately
                if (window.EJS && typeof window.EJS === 'object') return resolve();

                // If a loader script is already present, attach handlers
                const existing = document.querySelector('script[data-emulatorjs-loader]');
                if (existing) {
                    existing.addEventListener('load', () => resolve());
                    existing.addEventListener('error', () => reject(new Error('emulator loader failed to load')));
                    return;
                }

                // Create script with an attribute to avoid duplicates
                const script = document.createElement('script');
                script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
                script.crossOrigin = 'anonymous';
                script.setAttribute('data-emulatorjs-loader', '1');

                const timer = setTimeout(() => {
                    script.onerror = null;
                    script.onload = null;
                    reject(new Error('emulator loader timed out'));
                }, timeoutMs);

                script.onload = () => {
                    clearTimeout(timer);
                    resolve();
                };
                script.onerror = () => {
                    clearTimeout(timer);
                    reject(new Error('emulator loader failed to load'));
                };

                document.body.appendChild(script);
            });
        }

        // Load a game: configure globals then ensure loader is available
        function loadGame(system, gamePath) {
            // UI: hide menu, show emulator area
            document.getElementById('game-menu').style.display = 'none';
            document.getElementById('emulator-container').style.display = 'block';
            showStatus('Preparing emulator...');

            // Configure emulator globals (EmulatorJS expects these)
            window.EJS_player = '#canvas';
            window.EJS_gameUrl = gamePath;
            window.EJS_core = (system || '').toLowerCase();
            window.EJS_startOnLoaded = true;

            // If served via file://, warn the user (many loaders require HTTP)
            if (location.protocol === 'file:') {
                showStatus('Running from file:// â€” start a local HTTP server (see instructions).', true);
            }

            // Load loader (once) and handle errors
            ensureEmulatorLoader().then(() => {
                showStatus('Emulator script loaded â€” launching game...');
                // Some loader implementations immediately start once globals are set.
                // If the loader exposes a start method you could call it here.
            }).catch(err => {
                console.error(err);
                showStatus('Failed to load emulator script. Check network or run via HTTP server.', true);
            });
        }
    </script>
</body>
</html>
